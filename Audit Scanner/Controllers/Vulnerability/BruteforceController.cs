using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using Audit_Scanner.Models;
using Audit_Scanner.Vulnerability.Models;
using SaltwaterTaffy.Container;
using MinimalisticTelnet;

namespace Audit_Scanner.Controllers.Vulnerability
{
    public class BruteforceController
    {
        private List<CredentialModel> Credentials { get; set; }
        private bool CredentialsLoaded { get; set; }
        private static string _CSVPath = @"..\..\Resources\Credentials.csv";

        public BruteforceController()
        {
            var credentialList = new List<CredentialModel>();

            if (File.Exists(_CSVPath))
            {
                try
                {
                    using (var csvReader = new StreamReader(_CSVPath))
                    {
                        while (!csvReader.EndOfStream)
                        {
                            var line = csvReader.ReadLine();
                            var entries = line.Split(',');

                            var combo = new CredentialModel
                            {
                                Manufacturer = entries[0],
                                Username = entries[1],
                                Password = entries[2]
                            };

                            credentialList.Add(combo);
                        }
                    }

                    // 
                    Credentials = credentialList.Distinct().ToList();

                    if (Credentials.Any())
                    {
                        CredentialsLoaded = true;
                    }
                    else
                    {
                        CredentialsLoaded = false;
                        Console.WriteLine(
                            "Resources/Credentials.csv no credentials found, please download the tool and restore the original csv file.");
                    }
                }
                catch
                {
                    CredentialsLoaded = false;
                    // Reading Resources/Credentials.csv failed. 
                    Console.WriteLine(
                        "Resources/Credentials.csv failed to load, please download the tool and restore the original csv file.");
                }
            }
            else
            {
                CredentialsLoaded = false;
                // Resources/Credentials.csv does not exist.
                Console.WriteLine("Resources/Credentials.csv not found.");
            }
        }

        public CredentialModel BruteforceTelnet(Host device)
        {
            if (CredentialsLoaded)
            {
                Console.WriteLine("Performing bruteforce on Telnet port 23, please wait...");

                // Only search through credentials where they're global default or manufacturer specific
                foreach (var combo in Credentials.Where(x => x.Manufacturer == ""))
                {
                    if (combo.Username == "admin" && combo.Password == "password")
                    {
                        var bp = true;
                    }
                    //create a new telnet connection
                    TelnetConnection telnet = new TelnetConnection(device.Address.ToString(), 23);

                    //login with a timeout of 100ms, and show server output
                    var login = telnet.Login(combo.Username, combo.Password, 100);

                    // server output should end with "$" or ">", otherwise the connection failed
                    var response = login.TrimEnd();
                    response = login.Substring(response.Length - 1, 1);

                    if (response != ":")
                    {
                        // At this point we know the connection was successful
                        Console.WriteLine("Bruteforce successful, logged in with the following details:");
                        Console.WriteLine($"Username: {combo.Username}");
                        Console.WriteLine($"Password: {combo.Password}");

                        combo.Successful = true;
                        return combo;
                    }
                }

                // At this point we have tried every credential and none have worked. Device is not vulnerable.
                Console.WriteLine("Bruteforce finished, this device does not have known default credentials");

                // We can return any credential that does not have the successful property set to true.
                return Credentials.FirstOrDefault();
            }
            else
            {
                Console.WriteLine(
                    "There was an issue loading credentials, bruteforce cannot continue without credentials.");
            }

            return Credentials.FirstOrDefault();
        }

        public CredentialModel BruteforceSSH(DeviceModel target)
        {
            if (CredentialsLoaded)
            {
            }
            else
            {
                Console.WriteLine(
                    "There was an issue loading credentials, bruteforce cannot continue without credentials.");
            }

            return Credentials.FirstOrDefault();
        }
    }
}